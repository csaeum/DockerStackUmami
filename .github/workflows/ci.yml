name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Docker Compose Validation
  docker-compose-validation:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from example
        run: |
          cp .env.example .env
          # Generate dummy passwords for validation
          sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=test_password_1234567890abcdef/' .env
          sed -i 's/^APP_SECRET=.*/APP_SECRET=test_secret_1234567890abcdef1234567890abcdef/' .env
          sed -i 's|^BACKUPVOLUME=.*|BACKUPVOLUME=/tmp/backups|' .env

      - name: Validate docker-compose.yaml
        run: docker compose config

  # YAML Linting
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint -c .yamllint docker-compose.yaml

  # Secrets Scan
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

  # Markdown Lint
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: '**/*.md'
